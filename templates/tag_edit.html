{% extends "base.html" %}

{% block body %}
<div class="base-content-card">
    <h2 class="base-content-title">Modifica Tag</h2>
    <p class="base-content-description">Modifica i dati del tag</p>
    
    <form method="POST" x-data='tagEditForm({{ tag|tojson }})' @click.away="showSuggestions = false">
        <div class="base-form-group">
            <label for="name">Nome Tag *</label>
            <input type="text" id="name" name="name" x-model="formData.name" required maxlength="20" value="{{ tag.name|e }}">
            <p class="text-sm text-gray-500 mt-1" x-show="formData.name.length >= 10" x-text="`${formData.name.length}/20 caratteri`"></p>
        </div>
        
        <div class="base-form-group">
            <label for="crew_member">Riassegna a Equipaggio</label>
            <input type="text" 
                   x-model="crewSearch"
                   @focus="showSuggestions = true; searchCrewMembers()"
                   @input.debounce.500ms="searchCrewMembers()"
                   placeholder="Cerca membro equipaggio..."
                   value="{{ tag.crew_member_name|default('')|e }}">
            <select x-cloak x-model="formData.crew_member_id" x-show="showSuggestions" name="crew_member_id">
                <option value="">Nessun membro equipaggio</option>
                <option disabled x-show="crewMembers.length === 0">Nessun risultato trovato</option>
                {% if tag.crew_member_id %}
                    <option value="{{ tag.crew_member_id|e }}" selected>{{ tag.crew_member_name|e }}</option>
                {% endif %}
                <template x-for="member in crewMembers" :key="member.id">
                    <option :value="member.id" x-text="member.name" :selected="member.id == formData.crew_member_id"></option>
                </template>
            </select>
        </div>
        
        <div class="base-form-actions">
            <button type="button" @click="window.location.href='/tag'" class="base-btn-secondary">
                Annulla
            </button>
            <button type="submit" class="base-btn-primary">
                Aggiorna Tag
            </button>
        </div>
    </form>
</div>

<script>
function tagEditForm(existingData) {
    return {
        formData: {
            name: existingData.name || '',
            crew_member_id: existingData.crew_member_id || ''
        },
        crewSearch: existingData.crew_member_name || '',
        crewMembers: existingData.crew_member_name ? [{id: existingData.crew_member_id, name: existingData.crew_member_name}] : [],
        showSuggestions: false,
        crewSearchController: null,
        
        async searchCrewMembers() {
            if (this.crewSearchController) {
                this.crewSearchController.abort();
            }
            this.crewSearchController = new AbortController();
            
            const query = this.crewSearch.trim();
            
            try {
                const response = await fetch('/api/crew/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query }),
                    signal: this.crewSearchController.signal
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                this.crewMembers = data.crew_members || [];
            } catch (error) {
                if (error.name === 'AbortError') {
                    return;
                }
                console.error('Crew search error:', error);
                this.crewMembers = [];
            } finally {
                this.crewSearchController = null;
            }
        }
    }
}
</script>
{% endblock %}