<div class="base-table-container" x-data="gateKeeperTable()" x-init="init()"
    <!-- Table Header -->
    <div class="base-table-header">
        <h2 class="base-table-title">{{ table_config.title }}</h2>
        <p class="base-table-description">{{ table_config.description }}</p>
        
        <!-- Filters Section -->
        {% if table_config.text_filters or table_config.select_filters or table_config.searchable_select_filters or table_config.date_filters or table_config.checkbox_filters %}
        <form method="GET" action="{{ request.path }}">
            <div class="base-filters-section">
                <!-- Text Filters -->
                {% for filter in table_config.text_filters %}
                <div class="base-filter-group">
                    <label class="base-filter-label">{{ filter.label }}</label>
                    <input 
                        type="text" 
                        name="{{ filter.key }}"
                        class="base-filter-input"
                        placeholder="{{ filter.placeholder }}"
                        value="{{ request.args.get(filter.key, '') }}"
                    >
                </div>
                {% endfor %}

                <!-- Searchable Select Filters (Text input + Dynamic dropdown) -->
                {% for filter in table_config.searchable_select_filters %}
                <div class="base-filter-group" x-data="searchableFilter('{{ filter.key }}', '{{ filter.search_endpoint }}', '{{ request.args.get(filter.key, '') }}')">
                    <label class="base-filter-label">{{ filter.label }}</label>
                    <input 
                        type="text" 
                        x-model="searchText"
                        @input.debounce.500ms="searchOptions()"
                        class="base-filter-input"
                        placeholder="{{ filter.placeholder }}"
                    >
                    <select 
                        x-show="options.length > 0"
                        x-model="selectedValue"
                        name="{{ filter.key }}"
                        class="base-filter-select"
                        @change="updateForm()"
                        style="margin-top: 4px;"
                    >
                        <option value="">Tutti</option>
                        <template x-for="option in options" :key="option.value">
                            <option :value="option.value" x-text="option.label"></option>
                        </template>
                    </select>
                </div>
                {% endfor %}

                <!-- Regular Select Filters -->
                {% for filter in table_config.select_filters %}
                <div class="base-filter-group">
                    <label class="base-filter-label">{{ filter.label }}</label>
                    <select 
                        name="{{ filter.key }}"
                        class="base-filter-select"
                    >
                        <option value="">Tutti</option>
                        {% for option in filter.options %}
                        <option value="{{ option.value }}" {% if request.args.get(filter.key) == option.value|string %}selected{% endif %}>{{ option.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}

                <!-- Date Filters -->
                {% for filter in table_config.date_filters %}
                <div class="base-filter-group">
                    <label class="base-filter-label">{{ filter.label }}</label>
                    <input 
                        type="datetime-local" 
                        name="{{ filter.key }}"
                        class="base-filter-input base-datetime-input"
                        value="{{ request.args.get(filter.key, filter.default_value) }}"
                    >
                </div>
                {% endfor %}

                <!-- Checkbox Filters -->
                {% if table_config.checkbox_filters %}
                <div class="base-checkbox-filters">
                    {% for filter in table_config.checkbox_filters %}
                    <div class="base-checkbox-group">
                        <input 
                            type="checkbox" 
                            name="{{ filter.key }}"
                            value="1"
                            class="base-checkbox"
                            id="{{ filter.key }}"
                            {% if request.args.get(filter.key) %}checked{% endif %}
                        >
                        <label for="{{ filter.key }}" class="base-filter-label">{{ filter.label }}</label>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Actions Bar -->
            <div class="base-actions-bar">
                <div style="display: flex; gap: 12px;">
                    <button type="submit" class="base-filter-reset" style="background-color: #2563eb; color: white; border-color: #2563eb;">
                        Applica Filtri
                    </button>
                    <a href="{{ request.path }}" class="base-filter-reset" style="text-decoration: none; display: inline-flex; align-items: center;">
                        Cancella Filtri
                    </a>
                </div>
                
                {% if table_config.allow_add %}
                <a href="{{ table_config.add_url }}" class="base-add-button" style="text-decoration: none; display: inline-flex; align-items: center;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    <span>{{ table_config.add_button_text or 'Aggiungi' }}</span>
                </a>
                {% endif %}
            </div>
        </form>
        {% endif %}
    </div>

    <!-- Table Content -->
    <div class="base-table-wrapper">
        <!-- Empty State -->
        {% if table_config.data|length == 0 %}
        <div class="base-empty-state">
            <div class="base-empty-state-icon">📋</div>
            <h3 class="base-empty-state-title">Nessun risultato</h3>
            <p class="base-empty-state-description">{{ table_config.empty_message }}</p>
        </div>
        {% endif %}

        <!-- Data Table -->
        {% if table_config.data|length > 0 %}
        <table class="base-data-table">
            <thead>
                <tr>
                    {% for column in table_config.columns %}
                    <th class="base-table-header-cell">{{ column.label }}</th>
                    {% endfor %}
                    {% if table_config.allow_edit or table_config.allow_delete %}
                    <th class="base-table-header-cell">Azioni</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for row in table_config.data %}
                <tr class="base-table-row">
                    {% for column in table_config.columns %}
                    <td class="base-table-cell">
                        {% if column.type == 'battery' %}
                        <div class="base-battery-indicator">
                            <span class="base-battery-icon {% if row[column.key] %}{% if row[column.key] <= 20 %}base-battery-low{% elif row[column.key] <= 60 %}base-battery-medium{% else %}base-battery-high{% endif %}{% endif %}">🔋</span>
                            <span>{% if row[column.key] %}{{ row[column.key] }}%{% endif %}</span>
                        </div>
                        {% elif column.type == 'datetime' %}
                        <span>{{ row[column.key] | datetime_format }}</span>
                        {% else %}
                        <span>{{ row[column.key] or '' }}</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                    
                    <!-- Actions Column -->
                    {% if table_config.allow_edit or table_config.allow_delete %}
                    <td class="base-table-cell">
                        <div class="base-action-buttons">
                            {% if table_config.allow_edit %}
                            <a href="{{ table_config.edit_url.replace('{id}', row.id|string) }}" 
                               class="base-action-button base-edit" 
                               title="Modifica"
                               style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </a>
                            {% endif %}
                            {% if table_config.allow_delete %}
                            <button 
                                class="base-action-button base-delete" 
                                @click="confirmDelete({{ row.id }}, '{{ row.name or row.crew_member_name or row.tag_name or 'questo elemento' }}')"
                                title="Elimina"
                            >
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"/>
                                    <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                                    <line x1="10" y1="11" x2="10" y2="17"/>
                                    <line x1="14" y1="11" x2="14" y2="17"/>
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>

    <!-- Pagination Info -->
    {% if table_config.data|length > 0 %}
    <div class="base-pagination-info">
        {% if table_config.total_count > table_config.data|length %}
        Visualizzati {{ table_config.data|length }} di {{ table_config.total_count }} risultati
        {% if table_config.page and table_config.page > 1 %}
        {% set prev_page = table_config.page - 1 %}
        <a href="{{ request.path }}?{% for key, value in request.args.items() %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ prev_page }}" 
           style="margin-left: 16px; color: #2563eb; text-decoration: none;">← Precedente</a>
        {% endif %}
        {% if table_config.data|length >= 50 %}
        {% set next_page = table_config.page + 1 %}
        <a href="{{ request.path }}?{% for key, value in request.args.items() %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ next_page }}" 
           style="margin-left: 16px; color: #2563eb; text-decoration: none;">Successiva →</a>
        {% endif %}
        {% else %}
        {{ table_config.data|length }} risultati
        {% endif %}
    </div>
    {% endif %}

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal" x-cloak class="base-modal-overlay" @click.self="showDeleteModal = false">
        <div class="base-modal-content" @click.stop>
            <h3 class="base-modal-title">Conferma Eliminazione</h3>
            <p class="base-modal-description">Sei sicuro di voler eliminare <strong x-text="itemToDeleteName"></strong>? Questa azione non può essere annullata.</p>
            <div class="base-modal-actions">
                <button class="base-modal-button base-secondary" @click="showDeleteModal = false">
                    Annulla
                </button>
                <button class="base-modal-button base-primary" @click="handleDelete()">
                    Elimina
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function gateKeeperTable() {
    return {
        // Modal only
        showDeleteModal: false,
        itemToDelete: null,
        itemToDeleteName: '',

        init() {
            // Auto-submit form when certain inputs change (with debounce)
            const textInputs = this.$el.querySelectorAll('input[type="text"]:not([x-model])'); // Exclude Alpine.js managed inputs
            const selects = this.$el.querySelectorAll('select:not([x-model])'); // Exclude Alpine.js managed selects
            const checkboxes = this.$el.querySelectorAll('input[type="checkbox"]');
            
            let debounceTimer;
            
            const submitForm = () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const form = this.$el.querySelector('form');
                    if (form) form.submit();
                }, 500);
            };
            
            textInputs.forEach(input => {
                input.addEventListener('input', submitForm);
            });
            
            selects.forEach(select => {
                select.addEventListener('change', () => {
                    const form = this.$el.querySelector('form');
                    if (form) form.submit();
                });
            });
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const form = this.$el.querySelector('form');
                    if (form) form.submit();
                });
            });
        },

        // Action handlers
        confirmDelete(itemId, itemName) {
            this.itemToDelete = itemId;
            this.itemToDeleteName = itemName;
            this.showDeleteModal = true;
        },

        async handleDelete() {
            if (this.itemToDelete) {
                try {
                    const deleteUrl = '{{ table_config.delete_url }}'.replace('{id}', this.itemToDelete);
                    const response = await fetch(deleteUrl, {
                        method: 'DELETE',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (response.ok) {
                        // Reload the page to show updated data
                        window.location.reload();
                    } else {
                        alert('Errore durante l\'eliminazione');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Errore durante l\'eliminazione');
                }
            }
            this.showDeleteModal = false;
            this.itemToDelete = null;
            this.itemToDeleteName = '';
        }
    };
}

// Searchable filter component
function searchableFilter(filterKey, searchEndpoint, initialValue) {
    return {
        filterKey: filterKey,
        searchEndpoint: searchEndpoint,
        searchText: '',
        selectedValue: initialValue,
        options: [],
        
        init() {
            // If there's an initial value, we should show it in the search text
            if (this.selectedValue) {
                this.loadInitialOption();
            }
        },
        
        async loadInitialOption() {
            // Load the label for the initially selected value
            try {
                const response = await fetch(this.searchEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        query: '',
                        selected_id: this.selectedValue 
                    })
                });
                
                const data = await response.json();
                if (data.options && data.options.length > 0) {
                    this.options = data.options;
                    const selectedOption = this.options.find(opt => opt.value == this.selectedValue);
                    if (selectedOption) {
                        this.searchText = selectedOption.label;
                    }
                }
            } catch (error) {
                console.error('Error loading initial option:', error);
            }
        },
        
        async searchOptions() {
            if (this.searchText.length < 2) {
                this.options = [];
                return;
            }
            
            try {
                const response = await fetch(this.searchEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: this.searchText })
                });
                
                const data = await response.json();
                this.options = data.options || [];
            } catch (error) {
                console.error('Search error:', error);
                this.options = [];
            }
        },
        
        updateForm() {
            // Update search text to show the selected option's label
            if (this.selectedValue) {
                const selectedOption = this.options.find(opt => opt.value == this.selectedValue);
                if (selectedOption) {
                    this.searchText = selectedOption.label;
                }
            } else {
                this.searchText = '';
            }
            
            // Auto-submit the form
            setTimeout(() => {
                const form = this.$el.closest('form');
                if (form) form.submit();
            }, 100);
        }
    };
}
</script>