<div class="base-table-container" x-data="gateKeeperTable()">
    <!-- Table Header -->
    <div class="base-table-header">
        <h2 class="base-table-title">{{ table_config.title }}</h2>
        <p class="base-table-description">{{ table_config.description }}</p>
        
        <!-- Filters Section -->
        {% if table_config.text_filters or table_config.select_filters or table_config.searchable_select_filters or table_config.date_filters or table_config.checkbox_filters %}
        <form id="filter-form" hx-get="{{ request.path }}/partial" 
              hx-target="#table-content" 
              hx-trigger="input delay:500ms from:input, change from:select, change from:input[type=checkbox], submit"
              hx-include="form"
              hx-indicator=".htmx-indicator"
              hx-push-url="true"
              style="margin: 0;">
            <div class="base-filters-section">
                <!-- Text Filters -->
                {% for filter in table_config.text_filters %}
                <div class="base-filter-group">
                    <label class="base-filter-label">{{ filter.label }}</label>
                    <input 
                        type="text" 
                        name="{{ filter.key }}"
                        class="base-filter-input"
                        placeholder="{{ filter.placeholder }}"
                        value="{{ request.args.get(filter.key, '') }}"
                    >
                </div>
                {% endfor %}

                <!-- Searchable Select Filters -->
                {% for filter in table_config.searchable_select_filters %}
                <div class="base-filter-group" x-data="searchSelectFilter('{{ filter.key }}', '{{ filter.search_endpoint }}')">
                    <label class="base-filter-label">{{ filter.label }}</label>
                    <input type="text"
                           x-model="searchText"
                           @input.debounce.500ms="searchOptions()"
                           class="base-filter-input"
                           placeholder="{{ filter.placeholder }}">
                    <select x-cloak name="{{ filter.key }}"
                            x-model="selectedValue"
                            class="base-filter-select"
                            x-show="options.length > 0 || searchText">
                        <option value="">{{ filter.placeholder }}</option>
                        <option disabled x-show="options.length === 0">Nessun risultato trovato</option>
                        <template x-for="opt in options" :key="opt.value">
                            <option :value="opt.value" x-text="opt.label"></option>
                        </template>
                    </select>
                </div>
                {% endfor %}

                <!-- Regular Select Filters -->
                {% for filter in table_config.select_filters %}
                <div class="base-filter-group">
                    <label class="base-filter-label">{{ filter.label }}</label>
                    <select 
                        name="{{ filter.key }}"
                        class="base-filter-select"
                    >
                        <option value="">Tutti</option>
                        {% for option in filter.options %}
                        <option value="{{ option.value }}" {% if request.args.get(filter.key) == option.value|string %}selected{% endif %}>{{ option.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}

                <!-- Date Filters -->
                {% for filter in table_config.date_filters %}
                <div class="base-filter-group">
                    <label class="base-filter-label">{{ filter.label }}</label>
                    <input 
                        type="datetime-local" 
                        name="{{ filter.key }}"
                        class="base-filter-input base-datetime-input"
                        value="{{ request.args.get(filter.key, filter.default_value) }}"
                    >
                </div>
                {% endfor %}

                <!-- Checkbox Filters -->
                {% if table_config.checkbox_filters %}
                <div class="base-checkbox-filters">
                    {% for filter in table_config.checkbox_filters %}
                    <div class="base-checkbox-group">
                        <input 
                            type="checkbox" 
                            name="{{ filter.key }}"
                            value="1"
                            class="base-checkbox"
                            id="{{ filter.key }}"
                            {% if request.args.get(filter.key) %}checked{% endif %}
                        >
                        <label for="{{ filter.key }}" class="base-filter-label">{{ filter.label }}</label>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Actions Bar -->
            <div class="base-actions-bar">
                <div style="display: flex; gap: 12px;">
                    <a href="{{ request.path }}" class="base-filter-reset" style="text-decoration: none; display: inline-flex; align-items: center;">
                        Cancella Filtri
                    </a>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    {% if table_config.allow_export %}
                    <a href="#" 
                    @click.prevent="exportLogs()" 
                    class="base-add-button" 
                    style="text-decoration: none; display: inline-flex; align-items: center; background-color: #10b981;"
                    onmouseover="this.style.backgroundColor='#059669'" 
                    onmouseout="this.style.backgroundColor='#10b981'">
                        <svg viewBox="0 0 484 484" width="16" height="16" xmlns="http://www.w3.org/2000/svg" style="fill: currentColor;">
                            <path d="M201 401v-45h59l-11-14h-48v-47h107v26l13 5V177c0-2 0-4 1-5v-10h6c4-3 8-5 13-5h58c5 0 9 2 13 5h20v54h-13v14h13v50h-13v14h13v27l14-6V33c0-9-7-17-17-17H17C7 16 0 24 0 33v366c0 6 3 11 7 14v2h6c1 1 2 1 4 1h290l-11-15H201zm122-370h108c1 0 2 1 2 2v48h-110V31zm0 65h110v52h-110V96zM201 31h107v50H201V31zm0 65h107v52H201V96zm0 66h107v54H201v-54zm0 68h107v50H201v-50zM66 401H15c-1 0-1-1-1-2v-43h52v45zm0-60H14v-47h52v47zm0-61H14v-50h52v50zm0-64H14v-54h52v54zm0-68H14V95h52v53zm120 253H80v-45h107v45zm0-60H80v-47h107v47zm0-61H80v-50h107v50zm0-64H80v-54h107v54zm0-68H80V95h107v53zm0-67H80V31h107v50zm296 241l-110 143c-1 2-3 2-5 2-2 0-3-1-5-2L253 319c-1-1-1-2-1-4 0-1 0-2 1-3 2-2 4-3 7-2l73 29V173c0-3 3-6 6-6h58c3 0 6 3 6 6v169l73-29c2-1 5 0 7 2 2 2 2 5 0 7z"/>
                        </svg>
                        <span>Esporta</span>
                    </a>
                    {% endif %}
                    
                    {% if table_config.allow_add %}
                    <a href="{{ table_config.add_url }}" class="base-add-button" style="text-decoration: none; display: inline-flex; align-items: center;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        <span>{{ table_config.add_button_text or 'Aggiungi' }}</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </form>
        {% endif %}
    </div>

    <!-- Table Content (This will be replaced by HTMX) -->
    <div id="table-content">
        {% include 'table_content_partial.html' %}
    </div>
</div>

<script>

function exportLogs() {
    const form = document.getElementById('filter-form');
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);
    window.location.href = '{{ table_config.export_url }}?' + params.toString();
}

function gateKeeperTable() {
    return {
        scrollToTop() {
            document.getElementById('table-content').scrollIntoView({ behavior: 'auto' });
        }
    };
}

// Search Select Filter component with race condition fix
function searchSelectFilter(filterKey, searchEndpoint) {
    return {
        searchText: '',
        selectedValue: '',
        options: [],
        searchController: null,
        
        async searchOptions() {
            if (this.searchController) {
                this.searchController.abort();
            }
            this.searchController = new AbortController();
            
            const query = this.searchText.trim();
            if (!query) {
                this.options = [];
                this.selectedValue = '';
                return;
            }
            
            try {
                const response = await fetch(searchEndpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: query}),
                    signal: this.searchController.signal
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                this.options = data.options || [];
            } catch (error) {
                if (error.name === 'AbortError') {
                    return;
                }
                console.error('Search error:', error);
                this.options = [];
            } finally {
                this.searchController = null;
            }
        }
    };
}
</script>